<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pattern Grading Request</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #ffffff;
            color: #333;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
        }

        .chart-background {
            background-color: #c62828;
            padding: 30px;
            border-radius: 10px;
        }

        .chart-header-inside {
            background-color: #fdeaea;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .chart-header-inside h1 {
            color: #b71c1c;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 0;
        }

        .chart-header-inside svg.ruler-icon {
            width: 28px;
            height: 28px;
            fill: #b71c1c;
        }

        .chart-header-inside p {
            font-size: 14px;
            color: #5d1f1f;
            margin-top: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th {
            background-color: #b71c1c;
            color: white;
            padding: 12px;
            font-weight: bold;
            border: 1px solid #b71c1c;
        }

        td {
            padding: 10px;
            text-align: center;
            background-color: #fdeaea;
            border: 1px solid #b71c1c;
        }

        .info-table td {
            padding: 0;
            text-align: center;
            border: 1px solid white;
        }

        .info-label {
            background-color: #b71c1c;
            color: white;
            font-weight: bold;
            padding: 12px;
        }

        .info-stack {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #fdeaea;
            border: 1px solid #b71c1c;
            height: 100%;
            font-weight: bold;
            position: relative;
        }

        .info-stack select {
            width: 100%;
            height: 100%;
            border: none;
            background-color: transparent;
            font-weight: bold;
            padding: 12px 36px 12px 12px;
            font-size: 14px;
            appearance: none;
            cursor: pointer;
        }

        .info-stack.dropdown-enabled::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 10px;
            width: 14px;
            height: 14px;
            transform: translateY(-50%);
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 140 140' xmlns='http://www.w3.org/2000/svg'%3E%3Cpolygon points='0,0 140,0 70,80' fill='black'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-size: 14px;
            background-position: center;
            pointer-events: none;
        }

        .section-label {
            background-color: #fdeaea;
            font-weight: bold;
            text-align: left;
            padding-left: 10px;
        }
        
        .section-label-editable {
            cursor: pointer;
        }

        td input[type="text"] {
            width: 60px;
            padding: 6px;
            border: 1px solid #b71c1c;
            border-radius: 4px;
            text-align: center;
            background-color: white;
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 30px;
        }

        .btn {
            padding: 16px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            color: white;
            background-color: #d32f2f;
            border: 2px solid white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background-color: #b71c1c;
        }

        .btn svg.icon {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .btn svg.icon-stroke {
            width: 26px;
            height: 26px;
            fill: none;
            stroke: white;
            stroke-width: 2;
        }

        .note {
            margin-top: 20px;
            font-style: italic;
            color: white;
            text-align: center;
        }

        select.sizing-toggle {
            background-color: #b71c1c;
            color: white;
            border: none;
            font-weight: bold;
            font-size: 14px;
            width: 100%;
            appearance: none;
            padding-right: 40px;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 140 140' xmlns='http://www.w3.org/2000/svg'%3E%3Cpolygon points='0,0 140,0 70,80' fill='white'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 20px;
            cursor: pointer;
        }

        .base-size-cell {
            background-color: #ffe0b2 !important;
        }
        .base-size-cell input {
            background-color: #ffe0b2 !important;
            color: #b71c1c;
            border-color: #b71c1c;
            font-weight: bold;
        }

        /* POM Number and Name Column Styles */
        .pom-number-cell {
            background-color: #e0e0e0;
            font-weight: bold;
            text-align: center;
            width: 60px;
            border-left: 2px solid #b71c1c !important;
        }

        .pom-name-cell {
            background-color: #fdeaea;
            font-weight: bold;
            text-align: left;
            padding-left: 15px;
            min-width: 200px;
            border-right: 2px solid #b71c1c !important;
            position: relative;
        }

        /* Chart Container with Fixed Dimensions and Scroll */
        .grading-table-container {
            overflow-x: auto;
            margin-top: 20px;
            border: 2px solid #b71c1c;
            border-radius: 8px;
            background-color: #fdeaea;
            max-width: 100%;
            width: 100%;
            position: relative;
        }

        .grading-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        /* Fixed column widths for better layout */
        .grading-table th:first-child,
        .grading-table td:first-child {
            width: 60px;
            min-width: 60px;
            max-width: 60px;
        }

        .grading-table th:nth-child(2),
        .grading-table td:nth-child(2) {
            width: 200px;
            min-width: 200px;
            max-width: 200px;
        }

        /* Size columns - 9 visible, 5 scrollable */
        .grading-table th:nth-child(n+3),
        .grading-table td:nth-child(n+3) {
            width: 80px;
            min-width: 80px;
            max-width: 80px;
        }

        /* Grade rule controls */
        .grade-rule-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background-color: #f8f8f8;
            border-radius: 6px;
        }

        .grade-rule-controls label {
            font-weight: bold;
            margin-right: 10px;
        }

        .grade-rule-controls select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #b71c1c;
            background-color: white;
            font-weight: bold;
        }

        .custom-grade-input {
            display: none;
            margin-left: 10px;
        }

        .custom-grade-input input {
            width: 80px;
            padding: 6px;
            border: 1px solid #b71c1c;
            border-radius: 4px;
            text-align: center;
        }
        
        /* POM management controls */
        .pom-management {
            display: flex;
            gap: 5px;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .pom-management-btn {
            background: #b71c1c;
            color: white;
            border: none;
            border-radius: 3px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
        }
        
        .pom-management-btn:hover {
            background: #8e0000;
        }
        
        /* Add POM modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #b71c1c;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #b71c1c;
        }
        
        .pom-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .pom-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .pom-item:last-child {
            border-bottom: none;
        }
        
        .pom-checkbox {
            margin-right: 10px;
        }
        
        .custom-pom-input {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .custom-pom-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #b71c1c;
            border-radius: 4px;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }
        
        .modal-btn {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        
        .modal-btn-primary {
            background-color: #b71c1c;
            color: white;
        }
        
        .modal-btn-secondary {
            background-color: #e0e0e0;
            color: #333;
        }
        
        .pom-name-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            padding-right: 60px;
        }
        
        .pom-name-text {
            flex: 1;
            cursor: move;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
        }
        
        .pom-name-text:hover {
            background-color: #ffebee;
        }
        
        /* Drag and drop styles */
        .dragging {
            background-color: #e3f2fd !important;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
            border: 2px solid #2196f3 !important;
            z-index: 100;
            position: relative;
        }
        
        .drag-over-top {
            border-top: 3px solid #2196f3 !important;
        }
        
        .drag-over-bottom {
            border-bottom: 3px solid #2196f3 !important;
        }
        
        .drag-ghost {
            opacity: 0.7;
        }
        
        .add-all-poms-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .add-all-poms-btn:hover {
            background-color: #388e3c;
        }
        
        .drag-handle {
            display: inline-block;
            margin-right: 8px;
            color: #757575;
            cursor: move;
            font-size: 16px;
        }
        
        .drag-handle::before {
            content: '≡';
            font-size: 18px;
        }
        
        .drag-instruction {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        
        /* Cross bar indicator */
        .cross-bar {
            position: absolute;
            left: 0;
            right: 0;
            height: 3px;
            background-color: #2196f3;
            z-index: 1000;
            pointer-events: none;
            display: none;
        }
        
        .cross-bar.visible {
            display: block;
        }
        
        /* Drag boundary constraints */
        .grading-table-container.drag-active {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="chart-background">
            <div class="chart-header-inside">
                <h1>
                    <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="ruler-icon">
                        <path d="M3 3v18h18L3 3zm3 13.5V15h1.5L15 7.5l1.5 1.5L7.5 18H6v-1.5z"></path>
                    </svg> Pattern Grading Request
                </h1>
                <p>Complete all fields before submitting or printing. Use inches (e.g. +2", -1"). Drag POMs to reorder.</p>
            </div>
            <table class="info-table">
                <tbody>
                    <tr>
                        <td class="info-label">GARMENT TYPE</td>
                        <td>
                            <div class="info-stack dropdown-enabled">
                                <select id="garment-type" onchange="loadPomsForGarment()">
                                    <option value="tops" selected>TOPS</option>
                                    <option value="shirts">SHIRTS</option>
                                    <option value="jackets">JACKETS</option>
                                    <option value="outerwear">OUTERWEAR</option>
                                    <option value="pants">PANTS</option>
                                    <option value="dresses">DRESSES</option>
                                    <option value="shorts">SHORTS</option>
                                    <option value="skirts">SKIRTS</option>
                                    <option value="underwear">UNDERWEAR</option>
                                    <option value="bodysuit">BODYSUIT</option>
                                    <option value="bikini">BIKINI</option>
                                    <option value="bikini-set">BIKINI SET</option>
                                    <option value="overall">OVERALL</option>
                                    <option value="coverall">COVERALL</option>
                                </select>
                            </div>
                        </td>
                        <td class="info-label">STYLE NAME</td>
                        <td>
                            <div class="info-stack">
                                <div id="style-name" contenteditable="true">SUMMER 2030</div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="info-label">SIZE CATEGORY</td>
                        <td>
                            <div class="info-stack dropdown-enabled">
                                <select id="size-category" onchange="updateBaseSizeOptions()">
                                    <option value="" disabled selected>Select size category</option>
                                </select>
                            </div>
                        </td>
                        <td class="info-label">BASE SIZE</td>
                        <td>
                            <div class="info-stack dropdown-enabled">
                                <select id="base-size-select">
                                    <option value="" disabled selected>Select base size</option>
                                </select>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <!-- Grade Rule Controls -->
            <div class="grade-rule-controls">
                <div>
                    <label for="grade-rule">Select Grade Rule:</label>
                    <select id="grade-rule" onchange="toggleCustomGradeInput(); applyGradeRuleToAllPoms()">
                        <option value="1.0">1.0 Inch Grade</option>
                        <option value="1.5">1.5 Inch Grade</option>
                        <option value="2.0" selected>2.0 Inch Grade</option>
                        <option value="3.0">3.0 Inch Grade</option>
                        <option value="4.0">4.0 Inch Grade</option>
                        <option value="custom">Custom Grade</option>
                    </select>
                    <div class="custom-grade-input" id="custom-grade-input">
                        <input type="number" id="custom-grade-value" step="0.1" min="0.1" max="10" placeholder="0.0" onchange="applyGradeRuleToAllPoms()">
                        <span>inches</span>
                    </div>
                </div>
                <div>
                    <label for="grading-direction">Grading Direction:</label>
                    <select id="grading-direction" onchange="applyGradeRuleToAllPoms()">
                        <option value="both">Both Directions</option>
                        <option value="up">Larger Sizes Only</option>
                        <option value="down">Smaller Sizes Only</option>
                    </select>
                </div>
            </div>
            
            <!-- Size Header Row -->
            <div class="grading-table-container" id="table-container">
                <div class="cross-bar" id="cross-bar"></div>
                <table id="grading-table" class="grading-table">
                    <thead>
                        <tr>
                            <th style="border-left: 2px solid #b71c1c;">POM #</th>
                            <th style="border-right: 2px solid #b71c1c;">Measurement Points</th>
                            <!-- Size headers will be added here dynamically -->
                        </tr>
                    </thead>
                    <tbody id="grading-tbody">
                        <!-- POM rows will be added here dynamically -->
                    </tbody>
                </table>
            </div>
            
            <div class="btn-group">
                <button class="btn" onclick="addSizeColumn()">
                    <svg viewbox="0 0 24 24" class="icon-stroke">
                        <circle r="10" cy="12" cx="12"></circle>
                        <path stroke="white" d="M12 8v8M8 12h8"></path>
                    </svg> ADD SIZE(S)
                </button>
                <button class="btn" onclick="removeSizeColumn()">
                    <svg viewbox="0 0 24 24" class="icon-stroke">
                        <circle r="10" cy="12" cx="12"></circle>
                        <path stroke="white" d="M8 12h8"></path>
                    </svg> REMOVE SIZE(S)
                </button>
                <button class="btn" onclick="clearAllData()">
                    <svg viewbox="0 0 24 24" class="icon">
                        <path d="M3 6h18v2H3V6zm2 3h14v12H5V9zm3 3v6h2v-6H8zm4 0v6h2v-6h-2z"></path>
                    </svg> CLEAR ALL
                </button>
                <button class="btn" onclick="showRequestForm()">
                    <svg viewbox="0 0 24 24" class="icon">
                        <circle fill="none" stroke-width="2" stroke="white" r="10" cy="12" cx="12"></circle>
                        <path fill="none" stroke-width="2" stroke="white" d="M8 12l3 3 5-6"></path>
                    </svg> GENERATE REQUEST
                </button>
            </div>
            <div class="note" id="base-size-note">Note: Base size is highlighted in orange. Drag POMs using the cross bar (≡) to reorder them.</div>
        </div>
    </div>

    <!-- Add POM Modal -->
    <div class="modal" id="add-pom-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add POMs</div>
                <button class="close-modal" onclick="closeAddPomModal()">&times;</button>
            </div>
            <div class="pom-list" id="available-poms-list">
                <!-- Available POMs will be populated here -->
            </div>
            <button class="add-all-poms-btn" onclick="addAllPoms()">Add All POMs</button>
            <div class="custom-pom-input">
                <input type="text" id="custom-pom-name" placeholder="Enter custom POM name">
                <button class="modal-btn modal-btn-primary" onclick="addCustomPom()">Add Custom</button>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="closeAddPomModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="addSelectedPoms()">Add Selected</button>
            </div>
        </div>
    </div>

    <script>
        // Size systems
        const CATALOG = {
            'alpha-standard': ['XS','S','M','L','XL','2XL','3XL','4XL','5XL'],
            'w-plus-alpha': ['1X','2X','3X','4X','5X'],
            'women-num': ['0','2','4','6','8','10','12','14','16','18','20','22','24','26','28','30','32'],
            'plus-w': ['14W','16W','18W','20W','22W','24W','26W','28W','30W','32W','34W','36W','38W','40W','42W','44W','46W','48W','50W'],
            'petite-p': ['0P','2P','4P','6P','8P','10P','12P','14P','16P','18P'],
            'tall-t': ['0T','2T','4T','6T','8T','10T','12T','14T','16T','18T'],
            'alpha-short': ['XS','S','M','L','XL','XXL','3XL','4XL','5XL'],
            'men-num': ['34','36','38','40','42','44','46','48','50','52','54','56','58','60'],
            'men-big': ['40B','42B','44B','46B','48B','50B','52B','54B','56B','58B','60B'],
            'men-big-tall': ['LT','XLT','2XLT','3XLT','4XLT','5XLT'],
            'mens-suit-R': ['34R','36R','38R','40R','42R','44R','46R','48R','50R','52R'],
            'mens-suit-S': ['34S','36S','38S','40S','42S','44S','46S','48S','50S','52S'],
            'mens-suit-L': ['34L','36L','38L','40L','42L','44L','46L','48L','50L','52L'],
            'child-num': ['2T','3T','4T','5T','6','7','8','10','12','14','16'],
            'boys-husky': ['8H','10H','12H','14H','16H','18H','20H'],
            'boys-slim': ['8S','10S','12S','14S','16S','18S','20S']
        };

        const SYSTEM_GROUPS = {
            Women: ['alpha-standard','w-plus-alpha','women-num','plus-w','petite-p','tall-t'],
            Men: ['alpha-short','men-num','men-big','men-big-tall','mens-suit-R','mens-suit-S','mens-suit-L'],
            Children: ['child-num','boys-husky','boys-slim'],
            Other: ['alpha-short']
        };

        // Garment type to size system mapping
        const GARMENT_SIZE_SYSTEMS = {
            'tops': 'alpha-standard',
            'shirts': 'alpha-short',
            'jackets': 'alpha-short',
            'outerwear': 'alpha-short',
            'pants': 'women-num',
            'dresses': 'women-num',
            'shorts': 'women-num',
            'skirts': 'women-num',
            'underwear': 'alpha-short',
            'bodysuit': 'alpha-short',
            'bikini': 'alpha-short',
            'bikini-set': 'alpha-short',
            'overall': 'alpha-short',
            'coverall': 'alpha-short'
        };

        // Default base sizes for each system
        const SYSTEM_SEED = {
            'alpha-standard': 'M',
            'w-plus-alpha': '1X',
            'women-num': '8',
            'plus-w': '16W',
            'petite-p': '4P',
            'tall-t': '4T',
            'alpha-short': 'M',
            'men-num': '38',
            'men-big': '44B',
            'men-big-tall': 'LT',
            'mens-suit-R': '38R',
            'mens-suit-S': '38S',
            'mens-suit-L': '38L',
            'child-num': '6',
            'boys-husky': '10H',
            'boys-slim': '10S'
        };

        // Size category display names
        const SIZE_CATEGORY_NAMES = {
            'alpha-standard': 'Regular (Missy)',
            'w-plus-alpha': 'Plus (Women)',
            'women-num': 'Numeric (Women)',
            'plus-w': 'Plus W',
            'petite-p': 'Petite',
            'tall-t': 'Tall',
            'alpha-short': 'Regular',
            'men-num': 'Numeric (Men)',
            'men-big': 'Big (Men)',
            'men-big-tall': 'Big & Tall',
            'mens-suit-R': 'Suit Regular',
            'mens-suit-S': 'Suit Short',
            'mens-suit-L': 'Suit Long',
            'child-num': 'Regular (Children)',
            'boys-husky': 'Husky (Boys)',
            'boys-slim': 'Slim (Boys)'
        };

        // Complete POMs by Garment Type
        const GARMENT_POMS = {
            'tops': [
                'NECK LINE CIR.', 'CHEST 1" BLW AH', 'WAIST', 'BTM HEM /HIP',
                'FRT LGHT HPS.', 'BCK LGHT CB.', 'ACROSS SH BCK', 'SH LGHT',
                'SLV LGHT CB.', 'AH CIR.', 'AH DROP FM SH SLANT', 'SLV OPEN.',
                'SLV CUFF WIDTH', 'SLV CUFF HEIGHT', 'SLV RIB WIDTH', 'SLV RIB HIGHT',
                'NECK WIDTH', 'FRT NECK DROP', 'BCK NECK DROP', 'COL. RIB WIDTH CB',
                'COL. RIB LGHT', 'FRT PLACKET LGHT', 'FRT PKT LEGHT', 'FRT PKT WIDHT'
            ],
            'shirts': [
                'NECK LINE CIR.', 'CHEST 1" BLW AH', 'WAIST', 'BTM HEM/HIP',
                'FRT LGHT HPS.', 'BCK LGHT CB.', 'ACROSS SH BCK', 'SH LGHT',
                'SLV LGHT CB.', 'AH CIR.', 'AH DROP FM SH SLANT', 'SLV OPEN.',
                'SLV CUFF WIDTH', 'SLV CUFF HEIGHT', 'NECK WIDTH', 'FRT NECK DROP',
                'BCK NECK DROP', 'TOP COL. WIDTH CB', 'TOP COL. POINT WIDTH',
                'TOP COL ( ) SPREAD', 'STND COL WIDTH', 'FRT PKT LEGHT', 'FRT PKT WIDHT'
            ],
            'jackets': [
                'NECK LINE CIR.', 'CHEST 1" BLW AH', 'WAIST', 'BTM HEM /HIP',
                'FRT LGHT HPS.', 'BCK LGHT CB.', 'ACROSS SH BCK', 'SH LGHT',
                'SLV LGHT CB.', 'AH CIR.', 'AH DROP FM SH SLANT', 'SLV OPEN.',
                'SLV CUFF WIDTH', 'SLV CUFF HEIGHT', 'NECK WIDTH', 'FRT NECK DROP',
                'BCK NECK DROP', 'TOP COL. WIDTH CB', 'TOP COL. POINT WIDTH',
                'TOP COL ( ) SPREAD', 'STND COL WIDTH', 'FRT PKT LEGHT', 'FRT PKT WIDHT'
            ],
            'outerwear': [
                'NECK LINE CIR.', 'CHEST 1" BLW AH', 'WAIST', 'BTM HEM /HIP',
                'FRT LGHT HPS.', 'BCK LGHT CB.', 'ACROSS SH BCK', 'SH LGHT',
                'SLV LGHT CB.', 'AH CIR.', 'AH DROP FM SH SLANT', 'SLV OPEN.',
                'SLV CUFF WIDTH', 'SLV CUFF HEIGHT', 'NECK WIDTH', 'FRT NECK DROP',
                'BCK NECK DROP', 'TOP COL. WIDTH CB', 'TOP COL. POINT WIDTH',
                'TOP COL ( ) SPREAD', 'STND COL WIDTH', 'FRT PKT LEGHT', 'FRT PKT WIDHT'
            ],
            'pants': [
                'CONT. WB', 'UPPER WB at TOP', 'LOWER WB at SEAM', 'STRT. WB',
                'WB HEIGHT', 'HIGH HIP ( ) BLW WB', 'LOW HIP ( ) UP CROT',
                'THIGHT 1" BLW CROT', 'KNEE ( ) BLW CROT', 'LEG OPENING',
                'FRT RISE', 'BCK RISE', 'INSEAM', 'FRT Dart LGTH BLW WB',
                'BCK Dart LGTH BLW WB', 'ZIPPER LGTH FLY', 'ZIPPER LGTH CB',
                'ZIPPER LGTH S. SEAM', 'FRT PKT OPENING', 'FRT PKT LGHT',
                'BCK PKT PLMT BLW WB', 'BCK PKT PLMT Frm CB', 'BCK PKT OPENING',
                'BCK PKT LENGTH'
            ],
            'dresses': [
                'HPS TO BTM HEM', 'FRT LGHT CENTER', 'BCK LGHT CENTER',
                'BUST 1" BLW AH', 'Waist CIR.', 'HIGH HIP ( ) BLW WB',
                'LOW HIP ( ) BLW WB', 'AH CIR.', 'AH DROP FM SH SLANT',
                'SH WIDTH', 'SLV LGTH Frm SH SEAM', 'SLV LGTH FM CB',
                'SLV OPEN.', 'SLV CUFF SIZE', 'NECK WIDTH', 'FRT NECK DROP',
                'BCK NECK DROP', 'Zipper LGTH CB', 'SLIT OPEN.', 'Bottom Hem Width',
                'AH Dart LGHT', 'BUST DART 1" BLW AH', 'FRENCH DART Frm WB', 'SH DART'
            ],
            'shorts': [
                'CONT. WB', 'UPPER WB at TOP', 'LOWER WB at SEAM', 'STRT. WB',
                'WB HEIGHT', 'HIGH HIP ( ) BLW WB', 'LOW HIP ( ) UP CROT',
                'THIGHT 1" BLW CROT', 'LEG OPENING', 'FRT RISE', 'BCK RISE',
                'INSEAM', 'FRT Dart LGTH BLW WB', 'BCK Dart LGTH BLW WB',
                'ZIPPER LGTH FLY', 'ZIPPER LGTH CB', 'ZIPPER LGTH S. SEAM',
                'FRT PKT OPENING', 'FRT PKT LGHT', 'BCK PKT PLMT BLW WB',
                'BCK PKT PLMT Frm CB', 'BCK PKT OPENING', 'BCK PKT LENGTH'
            ],
            'skirts': [
                'CONT. WB', 'UPPER WB at TOP', 'LOWER WB at SEAM', 'STRT. WB',
                'WB HEIGHT', 'HIGH HIP ( ) BLW WB', 'LOW HIP ( ) BLW WB',
                'S. SEAM LGTH', 'CF LGTH Frm TOP WB', 'CB LGTH Frm TOP WB',
                'HEM SWEEP', 'SLIT OPEN.', 'BCK VENT OPEN.', 'FRT Dart LGTH BLW WB',
                'BCK Dart LGTH BLW WB', 'ZIPPER LGTH FLY', 'ZIPPER LGTH CB',
                'ZIPPER LGTH S. SEAM', 'FRT PKT OPENING', 'FRT PKT LGHT',
                'BCK PKT PLMT BLW WB', 'BCK PKT PLMT Frm CB', 'BCK PKT OPENING',
                'BCK PKT LENGTH'
            ],
            'underwear': [
                'ELASTIC WAIST HEIGHT', 'ELASTIC WAIST LGHT', 'WAIST BLW WB',
                'HIPS', 'S SEAM LGHT BLW WB', 'LEG OPEN.', 'FRT RISE', 'BCK RISE'
            ],
            'bodysuit': [
                'CUP', 'BUST', 'WAIST', 'HIP', 'S SEAM LGHT', 'CROTCH WIDTH at OPEN.',
                'SH LGHT', 'SLV LGHT CB.', 'AH CIR.', 'AH DROP FM SH SLANT', 'SLV OPEN.'
            ],
            'bikini': [
                'CUP', 'BUST', 'WAIST', 'HIP'
            ],
            'bikini-set': [
                'CUP', 'BUST', 'WAIST', 'HIP'
            ],
            'overall': [
                'MAX. STRAP LGHT', 'BIB LGHT', 'BIB WIDTH AT TOP', 'BIB WIDTH AT BTM',
                'WAIST', 'HIGH HIP ( ) BLW WB', 'S. SEAM', 'THIGHT 1" BLW CROT',
                'KNEE ( ) BLW CROT', 'LEG OPENING', 'FRT RISE', 'BCK RISE', 'INSEAM'
            ],
            'coverall': [
                'TOTAL LEGHT', 'NECK WIDTH', 'FRT NECK DROP', 'BCK NECK DROP',
                'TOP COL. WIDTH CB', 'TOP COL. POINT WIDTH', 'TOP COL ( ) SPREAD',
                'CHEST 1" BLW AH', 'WAIST', 'HIGH HIP ( ) BLW WB', 'ACROSS SH BCK',
                'SLV LGHT CB.', 'AH DROP FM SH SLANT', 'THIGHT 1" BLW CROT',
                'KNEE ( )BLW CROT', 'LEG OPENING', 'FRT RISE', 'BCK RISE', 'INSEAM',
                'BOOT SIZE', 'BOOT OPEN.', 'BOOT HEIGHT', 'INSOLE LGHT', 'INSOLE WIDHT'
            ]
        };

        // Global variables
        let currentBaseSize = '';
        let nextCustomSizeIndex = 1;
        let currentSizeSystem = '';
        let currentGarmentType = 'tops';
        let currentPoms = [];
        let draggedRow = null;
        let crossBar = null;

        document.addEventListener('DOMContentLoaded', () => {
            const sizeSelect = document.getElementById('base-size-select');
            sizeSelect.addEventListener('change', changeBaseSize);
            
            // Initialize with default values
            updateSizeCategories();
            
            // Initialize the garment type change listener
            document.getElementById('garment-type').addEventListener('change', updateSizeCategories);
            
            // Initialize the table with default sizes
            updateSizeHeaders();
            
            // Initialize custom grade input visibility
            toggleCustomGradeInput();
            
            // Get cross bar element
            crossBar = document.getElementById('cross-bar');
        });
        
        // --- Garment Type and Size Category Management ---
        
        function updateSizeCategories() {
            const garmentType = document.getElementById('garment-type').value;
            const sizeCategorySelect = document.getElementById('size-category');
            currentGarmentType = garmentType;
            
            // Clear existing options
            sizeCategorySelect.innerHTML = '<option value="" disabled selected>Select size category</option>';
            
            if (garmentType && GARMENT_SIZE_SYSTEMS[garmentType]) {
                const system = GARMENT_SIZE_SYSTEMS[garmentType];
                currentSizeSystem = system;
                
                // Find which group this system belongs to
                let groupName = '';
                for (const [group, systems] of Object.entries(SYSTEM_GROUPS)) {
                    if (systems.includes(system)) {
                        groupName = group;
                        break;
                    }
                }
                
                // Add relevant size categories based on the group
                if (groupName === 'Women') {
                    addSizeCategoryOption('alpha-standard', 'Regular (Missy)');
                    addSizeCategoryOption('w-plus-alpha', 'Plus (Women)');
                    addSizeCategoryOption('women-num', 'Numeric (Women)');
                    addSizeCategoryOption('plus-w', 'Plus W');
                    addSizeCategoryOption('petite-p', 'Petite');
                    addSizeCategoryOption('tall-t', 'Tall');
                } else if (groupName === 'Men') {
                    addSizeCategoryOption('alpha-short', 'Regular');
                    addSizeCategoryOption('men-num', 'Numeric (Men)');
                    addSizeCategoryOption('men-big', 'Big (Men)');
                    addSizeCategoryOption('men-big-tall', 'Big & Tall');
                    addSizeCategoryOption('mens-suit-R', 'Suit Regular');
                    addSizeCategoryOption('mens-suit-S', 'Suit Short');
                    addSizeCategoryOption('mens-suit-L', 'Suit Long');
                } else if (groupName === 'Children') {
                    addSizeCategoryOption('child-num', 'Regular (Children)');
                    addSizeCategoryOption('boys-husky', 'Husky (Boys)');
                    addSizeCategoryOption('boys-slim', 'Slim (Boys)');
                } else {
                    addSizeCategoryOption('alpha-short', 'Regular');
                }
                
                // Set default size category based on garment type
                sizeCategorySelect.value = system;
                
                // Update base size options
                updateBaseSizeOptions();
                
                // Load POMs for the selected garment type
                loadPomsForGarment();
            }
        }
        
        function addSizeCategoryOption(value, text) {
            const sizeCategorySelect = document.getElementById('size-category');
            const option = document.createElement('option');
            option.value = value;
            option.textContent = text;
            sizeCategorySelect.appendChild(option);
        }
        
        function updateBaseSizeOptions() {
            const sizeCategory = document.getElementById('size-category').value;
            const baseSizeSelect = document.getElementById('base-size-select');
            
            // Clear existing options
            baseSizeSelect.innerHTML = '<option value="" disabled selected>Select base size</option>';
            
            if (sizeCategory && CATALOG[sizeCategory]) {
                const sizes = CATALOG[sizeCategory];
                currentSizeSystem = sizeCategory;
                
                sizes.forEach(size => {
                    const option = document.createElement('option');
                    option.value = size;
                    option.textContent = size;
                    baseSizeSelect.appendChild(option);
                });
                
                // Set default base size
                const defaultSize = SYSTEM_SEED[sizeCategory] || sizes[Math.floor(sizes.length / 2)];
                baseSizeSelect.value = defaultSize;
                currentBaseSize = defaultSize;
                
                // Update the table with new sizing
                updateSizeHeaders();
            }
        }
        
        // --- Core Functionality: Load POMs based on Garment Type ---
        
        function loadPomsForGarment() {
            const garmentType = document.getElementById('garment-type').value;
            const allPoms = GARMENT_POMS[garmentType] || [];
            
            // Start with first 8 POMs by default
            currentPoms = allPoms.slice(0, 8);
            
            const tbody = document.getElementById('grading-tbody');
            
            // Clear existing rows
            tbody.innerHTML = ''; 

            currentPoms.forEach((pomName, index) => {
                const newRow = createPomRow(pomName, index + 1);
                tbody.appendChild(newRow);
            });
            
            // Apply base size styling to the newly loaded table
            updateBaseSizeVisual();
            
            // Initialize drag and drop
            initializeDragAndDrop();
        }
        
        function createPomRow(pomName, pomNumber) {
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-pom', pomName);
            newRow.setAttribute('draggable', 'true');
            
            // 1. POM Number cell
            const numberCell = document.createElement('td');
            numberCell.className = 'pom-number-cell';
            numberCell.textContent = pomNumber;
            newRow.appendChild(numberCell);

            // 2. POM Name cell with management controls
            const nameCell = document.createElement('td');
            nameCell.className = 'pom-name-cell section-label-editable';
            
            // POM name and management controls
            const pomNameWrapper = document.createElement('div');
            pomNameWrapper.className = 'pom-name-wrapper';
            
            const pomNameText = document.createElement('div');
            pomNameText.className = 'pom-name-text';
            
            // Add drag handle (cross bar)
            const dragHandle = document.createElement('span');
            dragHandle.className = 'drag-handle';
            dragHandle.title = 'Drag to reorder';
            pomNameText.appendChild(dragHandle);
            
            // Add POM name
            const pomNameSpan = document.createElement('span');
            pomNameSpan.textContent = pomName;
            pomNameText.appendChild(pomNameSpan);
            
            pomNameWrapper.appendChild(pomNameText);
            
            // POM management buttons
            const pomManagementDiv = document.createElement('div');
            pomManagementDiv.className = 'pom-management';
            
            const addBtn = document.createElement('button');
            addBtn.className = 'pom-management-btn';
            addBtn.innerHTML = '+';
            addBtn.title = 'Add POMs';
            addBtn.onclick = function() {
                showAddPomModal();
            };
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'pom-management-btn';
            deleteBtn.innerHTML = '&minus;';
            deleteBtn.title = 'Remove this POM';
            deleteBtn.onclick = function() {
                removePomRowByIndex(pomNumber - 1);
            };
            
            pomManagementDiv.appendChild(addBtn);
            pomManagementDiv.appendChild(deleteBtn);
            pomNameWrapper.appendChild(pomManagementDiv);
            
            nameCell.appendChild(pomNameWrapper);
            newRow.appendChild(nameCell);

            // 3. Input cells
            const headerCells = document.querySelectorAll('#grading-table thead th[data-size]');
            headerCells.forEach(th => {
                const size = th.getAttribute('data-size');
                const newTd = document.createElement('td');
                newTd.setAttribute('data-size', size);
                
                const newInput = document.createElement('input');
                newInput.type = 'text';
                newInput.value = '';
                // Add event listener to base size cells to auto-update when changed
                if (size === currentBaseSize) {
                    newInput.addEventListener('input', function() {
                        applyGradeRuleToPomRow(newRow);
                    });
                }

                newTd.appendChild(newInput);
                newRow.appendChild(newTd);
            });
            
            return newRow;
        }

        // --- POM Management Functions ---
        
        function showAddPomModal() {
            const modal = document.getElementById('add-pom-modal');
            const pomList = document.getElementById('available-poms-list');
            
            // Get all available POMs for current garment type
            const allPoms = GARMENT_POMS[currentGarmentType] || [];
            const availablePoms = allPoms.filter(pom => !currentPoms.includes(pom));
            
            // Clear the list
            pomList.innerHTML = '';
            
            // Add available POMs to the list
            availablePoms.forEach(pom => {
                const pomItem = document.createElement('div');
                pomItem.className = 'pom-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'pom-checkbox';
                checkbox.value = pom;
                
                const label = document.createElement('label');
                label.textContent = pom;
                
                pomItem.appendChild(checkbox);
                pomItem.appendChild(label);
                pomList.appendChild(pomItem);
            });
            
            // Show the modal
            modal.style.display = 'flex';
        }
        
        function closeAddPomModal() {
            const modal = document.getElementById('add-pom-modal');
            modal.style.display = 'none';
        }
        
        function addSelectedPoms() {
            const checkboxes = document.querySelectorAll('#available-poms-list .pom-checkbox:checked');
            const pomsToAdd = Array.from(checkboxes).map(cb => cb.value);
            
            if (pomsToAdd.length > 0) {
                // Add selected POMs to current POMs
                currentPoms = [...currentPoms, ...pomsToAdd];
                
                // Rebuild the table
                rebuildPomTable();
                
                // Close the modal
                closeAddPomModal();
            } else {
                alert('Please select at least one POM to add.');
            }
        }
        
        function addAllPoms() {
            const allPoms = GARMENT_POMS[currentGarmentType] || [];
            
            // Add all POMs to current POMs
            currentPoms = [...new Set([...currentPoms, ...allPoms])];
            
            // Rebuild the table
            rebuildPomTable();
            
            // Close the modal
            closeAddPomModal();
        }
        
        function addCustomPom() {
            const customPomInput = document.getElementById('custom-pom-name');
            const customPomName = customPomInput.value.trim();
            
            if (customPomName) {
                // Add custom POM to current POMs
                currentPoms.push(customPomName);
                
                // Rebuild the table
                rebuildPomTable();
                
                // Clear the input and close the modal
                customPomInput.value = '';
                closeAddPomModal();
            } else {
                alert('Please enter a custom POM name.');
            }
        }
        
        function removePomRowByIndex(index) {
            if (currentPoms.length > 1) {
                // Remove the POM from current POMs
                currentPoms.splice(index, 1);
                
                // Rebuild the table
                rebuildPomTable();
            } else {
                alert("Cannot remove the last POM. You need at least one POM.");
            }
        }
        
        function rebuildPomTable() {
            const tbody = document.getElementById('grading-tbody');
            
            // Clear existing rows
            tbody.innerHTML = ''; 

            // Recreate all rows
            currentPoms.forEach((pomName, index) => {
                const newRow = createPomRow(pomName, index + 1);
                tbody.appendChild(newRow);
            });
            
            // Apply base size styling
            updateBaseSizeVisual();
            
            // Re-apply grade rules
            applyGradeRuleToAllPoms();
            
            // Re-initialize drag and drop
            initializeDragAndDrop();
        }

        // --- Drag and Drop Functionality ---
        
        function initializeDragAndDrop() {
            const rows = document.querySelectorAll('#grading-tbody tr');
            const tableContainer = document.getElementById('table-container');
            
            rows.forEach(row => {
                // Remove existing event listeners
                row.removeEventListener('dragstart', handleDragStart);
                row.removeEventListener('dragover', handleDragOver);
                row.removeEventListener('drop', handleDrop);
                row.removeEventListener('dragend', handleDragEnd);
                
                // Add new event listeners
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragend', handleDragEnd);
            });
            
            // Add container events for boundary constraints
            tableContainer.addEventListener('dragover', handleContainerDragOver);
            tableContainer.addEventListener('dragleave', handleContainerDragLeave);
        }
        
        function handleDragStart(e) {
            draggedRow = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            
            // Set drag image to be the row itself
            const rect = this.getBoundingClientRect();
            const dragImage = this.cloneNode(true);
            dragImage.style.width = `${rect.width}px`;
            dragImage.style.opacity = '0.8';
            dragImage.style.position = 'absolute';
            dragImage.style.top = '-1000px';
            document.body.appendChild(dragImage);
            e.dataTransfer.setDragImage(dragImage, 20, 20);
            
            setTimeout(() => {
                document.body.removeChild(dragImage);
            }, 0);
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            // Constrain dragging within table container
            const tableContainer = document.getElementById('table-container');
            const containerRect = tableContainer.getBoundingClientRect();
            
            // Show cross bar at current position
            const afterElement = getDragAfterElement(this.parentNode, e.clientY);
            const allRows = Array.from(this.parentNode.children);
            
            // Remove previous drag-over classes
            allRows.forEach(row => {
                row.classList.remove('drag-over-top', 'drag-over-bottom');
            });
            
            // Calculate cross bar position
            let crossBarTop;
            if (afterElement) {
                const rect = afterElement.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;
                
                if (e.clientY < midpoint) {
                    afterElement.classList.add('drag-over-top');
                    crossBarTop = rect.top - containerRect.top - 1;
                } else {
                    afterElement.classList.add('drag-over-bottom');
                    crossBarTop = rect.top - containerRect.top + rect.height - 1;
                }
            } else {
                // Last position
                const lastRow = allRows[allRows.length - 1];
                if (lastRow !== draggedRow) {
                    lastRow.classList.add('drag-over-bottom');
                    const rect = lastRow.getBoundingClientRect();
                    crossBarTop = rect.top - containerRect.top + rect.height - 1;
                } else {
                    crossBarTop = containerRect.height - 2;
                }
            }
            
            // Position and show cross bar
            if (crossBarTop !== undefined) {
                crossBar.style.top = `${crossBarTop}px`;
                crossBar.classList.add('visible');
            }
        }
        
        function handleContainerDragOver(e) {
            e.preventDefault();
            // Keep the cross bar visible while dragging over container
        }
        
        function handleContainerDragLeave(e) {
            // Hide cross bar when leaving container
            if (!e.relatedTarget || !document.getElementById('table-container').contains(e.relatedTarget)) {
                crossBar.classList.remove('visible');
            }
        }
        
        function handleDrop(e) {
            e.preventDefault();
            
            const afterElement = getDragAfterElement(this.parentNode, e.clientY);
            const container = this.parentNode;
            
            if (afterElement == null) {
                container.appendChild(draggedRow);
            } else {
                container.insertBefore(draggedRow, afterElement);
            }
            
            // Hide cross bar
            crossBar.classList.remove('visible');
            
            // Remove drag-over classes
            const allRows = Array.from(container.children);
            allRows.forEach(row => {
                row.classList.remove('drag-over-top', 'drag-over-bottom');
            });
            
            return false;
        }
        
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            
            // Hide cross bar
            crossBar.classList.remove('visible');
            
            // Remove all drag-over classes
            const allRows = Array.from(this.parentNode.children);
            allRows.forEach(row => {
                row.classList.remove('drag-over-top', 'drag-over-bottom');
            });
            
            // Update currentPoms array based on new order
            const tbody = document.getElementById('grading-tbody');
            const newPoms = [];
            
            Array.from(tbody.rows).forEach((row, index) => {
                const pomName = row.getAttribute('data-pom');
                newPoms.push(pomName);
                // Update POM number
                row.cells[0].textContent = index + 1;
            });
            
            currentPoms = newPoms;
        }
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('tr:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- Size Management Functions ---

        function getCurrentSizeOptions() {
            if (currentSizeSystem && CATALOG[currentSizeSystem]) {
                return CATALOG[currentSizeSystem];
            }
            return ['XS','S','M','L','XL','XXL'];
        }

        function updateSizeHeaders() {
            const theadRow = document.querySelector('#grading-table thead tr');
            const tbody = document.getElementById('grading-tbody');
            const sizeOptions = getCurrentSizeOptions();
            
            // Remove all current size headers (keep the first two <th> which are "POM #" and "Measurement Points")
            const existingHeaders = theadRow.querySelectorAll('th[data-size]');
            existingHeaders.forEach(th => th.remove());
            
            // Remove all data cells from rows (keep the first two cells which are POM number and name)
            tbody.querySelectorAll('tr').forEach(tr => {
                Array.from(tr.cells).slice(2).forEach(td => td.remove());
            });

            // Add new headers (max 14 - 9 visible, 5 scrollable)
            const maxSizes = Math.min(14, sizeOptions.length);
            
            for(let i = 0; i < maxSizes; i++) {
                const sizeValue = sizeOptions[i];
                
                // Add new header
                const newTh = document.createElement('th');
                newTh.setAttribute('data-size', sizeValue);
                newTh.textContent = sizeValue;
                theadRow.appendChild(newTh);

                // Add new cells to all existing POM rows
                tbody.querySelectorAll('tr').forEach(tr => {
                    const newTd = document.createElement('td');
                    newTd.setAttribute('data-size', sizeValue);
                    const newInput = document.createElement('input');
                    newInput.type = 'text';
                    newInput.value = '';
                    newTd.appendChild(newInput);
                    tr.appendChild(newTd);
                });
            }

            updateBaseSizeVisual();
        }

        function changeBaseSize(event) {
            currentBaseSize = event.target.value;
            updateBaseSizeVisual();
            // Re-apply grade rule when base size changes
            applyGradeRuleToAllPoms();
        }

        function updateBaseSizeVisual() {
            const table = document.getElementById('grading-table');
            const note = document.getElementById('base-size-note');
            const headerCells = table.querySelectorAll('thead th[data-size]');

            // 1. Reset all cells
            table.querySelectorAll('tbody td').forEach(td => {
                td.classList.remove('base-size-cell');
                const input = td.querySelector('input');
                if (input) {
                    // Remove readonly attribute to allow user input
                    input.removeAttribute('readonly');
                    // Remove any existing event listeners
                    input.oninput = null;
                }
            });

            // 2. Identify the size column index (1-based index in the row)
            let baseSizeIndex = -1;
            headerCells.forEach((th, index) => {
                if (th.getAttribute('data-size') === currentBaseSize) {
                    baseSizeIndex = index;
                }
            });

            // 3. Apply base size style and add event listeners
            if (baseSizeIndex !== -1) {
                // The size columns start at cell index 2 (index 0 is POM number, index 1 is POM name)
                const columnIndex = baseSizeIndex + 2; 
                table.querySelectorAll(`#grading-tbody tr`).forEach(row => {
                    const baseCell = row.cells[columnIndex];
                    if (baseCell) {
                        baseCell.classList.add('base-size-cell');
                        const input = baseCell.querySelector('input');
                        if (input) {
                            // Add event listener to auto-update when base size value changes
                            input.addEventListener('input', function() {
                                applyGradeRuleToPomRow(row);
                            });
                        }
                    }
                });
            }

            // 4. Update the note
            const baseSizeText = document.getElementById('base-size-select').options[document.getElementById('base-size-select').selectedIndex]?.textContent || currentBaseSize;
            note.textContent = `Note: Base size (${baseSizeText}) is highlighted in orange. Drag POMs using the cross bar (≡) to reorder them.`;
        }

        // --- Grade Rule Functions ---

        function toggleCustomGradeInput() {
            const gradeRuleSelect = document.getElementById('grade-rule');
            const customGradeInput = document.getElementById('custom-grade-input');
            
            if (gradeRuleSelect.value === 'custom') {
                customGradeInput.style.display = 'inline-block';
            } else {
                customGradeInput.style.display = 'none';
            }
            
            // Auto-apply the new grade rule
            applyGradeRuleToAllPoms();
        }

        function getGradeIncrement() {
            const gradeRuleSelect = document.getElementById('grade-rule');
            
            if (gradeRuleSelect.value === 'custom') {
                const customValue = parseFloat(document.getElementById('custom-grade-value').value);
                return isNaN(customValue) ? 2.0 : customValue;
            }
            
            return parseFloat(gradeRuleSelect.value);
        }

        // --- Auto-Grading Functions ---

        function applyGradeRuleToPomRow(row) {
            const headerCells = document.querySelectorAll('#grading-table thead th[data-size]');
            const sizes = Array.from(headerCells).map(th => th.getAttribute('data-size'));
            const baseSizeIndex = sizes.indexOf(currentBaseSize);
            
            if (baseSizeIndex === -1) return;
            
            // Get the base size value
            const baseSizeCell = row.cells[baseSizeIndex + 2]; // +2 because of POM number and name columns
            const baseSizeInput = baseSizeCell.querySelector('input');
            const baseValue = parseFloat(baseSizeInput.value);
            
            if (isNaN(baseValue)) return;
            
            // Get grading direction and increment
            const direction = document.getElementById('grading-direction').value;
            const increment = getGradeIncrement();
            
            // Calculate increments for each size
            sizes.forEach((size, index) => {
                if (index === baseSizeIndex) return; // Skip base size
                
                const sizeCell = row.cells[index + 2];
                const sizeInput = sizeCell.querySelector('input');
                
                // Calculate the difference in position from base size
                const diff = index - baseSizeIndex;
                
                // Apply grading based on direction
                if ((direction === 'both') || 
                    (direction === 'up' && diff > 0) || 
                    (direction === 'down' && diff < 0)) {
                    
                    const gradedValue = baseValue + (diff * increment);
                    
                    // Format the value (add + for positive increments)
                    sizeInput.value = gradedValue > 0 ? `+${gradedValue.toFixed(1)}"` : `${gradedValue.toFixed(1)}"`;
                }
            });
        }

        function applyGradeRuleToAllPoms() {
            const rows = document.querySelectorAll('#grading-tbody tr');
            rows.forEach(row => {
                applyGradeRuleToPomRow(row);
            });
        }

        // --- Button Functionality ---

        function addSizeColumn() {
            const theadRow = document.querySelector('#grading-table thead tr');
            const tbody = document.getElementById('grading-tbody');
            
            // Check if one of the preset sizes can be added back
            const currentSizeOptions = getCurrentSizeOptions();
            const currentSizeHeaders = Array.from(theadRow.querySelectorAll('th[data-size]'));
            const currentSizeNames = currentSizeHeaders.map(th => th.getAttribute('data-size'));
            
            let newSize = null;
            let isPresetSize = false;

            // Find the next available preset size
            for (const size of currentSizeOptions) {
                if (!currentSizeNames.includes(size)) {
                    newSize = size;
                    isPresetSize = true;
                    break;
                }
            }

            // If all preset sizes are added, use a custom size
            if (!newSize) {
                newSize = `Custom${nextCustomSizeIndex}`;
                nextCustomSizeIndex++;
            }

            // Check if we've reached the maximum of 14 sizes
            if (currentSizeHeaders.length >= 14) {
                alert("Maximum of 14 sizes reached. Please remove a size before adding another.");
                return;
            }

            // 1. Add Header
            const newTh = document.createElement('th');
            newTh.setAttribute('data-size', newSize);
            newTh.textContent = newSize;
            theadRow.appendChild(newTh);

            // 2. Add cells to all rows
            tbody.querySelectorAll('tr').forEach(tr => {
                const newTd = document.createElement('td');
                newTd.setAttribute('data-size', newSize);
                const newInput = document.createElement('input');
                newInput.type = 'text';
                newInput.value = '';
                newTd.appendChild(newInput);
                tr.appendChild(newTd);
            });
            
            updateBaseSizeVisual();
            // Re-apply grade rule after adding new size column
            applyGradeRuleToAllPoms();
        }

        function removeSizeColumn() {
            const theadRow = document.querySelector('#grading-table thead tr');
            const headerCells = theadRow.querySelectorAll('th[data-size]');
            
            // Ensure there are enough columns to remove (at least 2 sizes needed)
            if (headerCells.length <= 2) {
                alert("Cannot remove more size columns. At least two sizes must remain.");
                return;
            }

            const columnToRemoveIndex = headerCells.length; // Index in the row (1-based because 0 is POM label)
            const sizeToRemove = headerCells[headerCells.length - 1].getAttribute('data-size');
            
            // Check if the base size is being removed
            if (sizeToRemove === currentBaseSize) {
                alert("Cannot remove the currently selected Base Size. Please change the Base Size before removing this column.");
                return;
            }

            // 1. Remove Header (last <th> with data-size)
            headerCells[headerCells.length - 1].remove();

            // 2. Remove last cell from all rows
            document.querySelectorAll('#grading-tbody tr').forEach(tr => {
                // The column index in the row is headerCells.length
                if (tr.cells.length > 2) {
                    tr.cells[columnToRemoveIndex + 1].remove(); // +1 because of POM number column
                }
            });
            
            // If the removed size was a Custom size, decrement the custom index counter
            if (sizeToRemove.startsWith('Custom')) {
                 nextCustomSizeIndex = parseInt(sizeToRemove.replace('Custom', '')) > 1 ? parseInt(sizeToRemove.replace('Custom', '')) : 1;
            }

            updateBaseSizeVisual();
        }

        function clearAllData() {
            const confirmation = confirm("Are you sure you want to clear ALL grading data? This will set all values to empty.");
            if (confirmation) {
                document.querySelectorAll('#grading-table input[type="text"]').forEach(input => {
                    input.value = '';
                });
            }
        }

        function showRequestForm() {
            const garmentType = document.getElementById('garment-type').value;
            const sizeCategory = document.getElementById('size-category').value;
            const baseSize = document.getElementById('base-size-select').value;
            
            if (!garmentType || !sizeCategory || !baseSize) {
                alert("Please select a garment type, size category, and base size before generating the request.");
                return;
            }
            
            alert("Request form would be shown here in a complete implementation.");
        }
    </script>
</body>
</html>